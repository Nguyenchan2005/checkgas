<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Gi√°m S√°t Gas - Simon House</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; text-align: center; padding: 20px; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; padding: 30px; }
        h2 { color: #333; margin-bottom: 5px; }
        .sub-title { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
        
        #gas-value { font-size: 80px; font-weight: bold; color: #2ecc71; margin: 10px 0; transition: color 0.3s; }
        #unit { font-size: 20px; color: #95a5a6; }
        
        #status-box { padding: 15px; border-radius: 8px; color: white; font-weight: bold; font-size: 18px; margin-top: 15px; transition: background-color 0.3s; }
        
        .footer { margin-top: 30px; font-size: 12px; color: #888; }
        #debug-error { color: red; font-size: 14px; margin-top: 10px; display: none;}
        
        /* Hi·ªáu ·ª©ng nh·∫•p nh√°y khi b√°o ƒë·ªông */
        @keyframes blinker { 50% { opacity: 0.5; } }
        .alarm-active { animation: blinker 0.8s linear infinite; background-color: #e74c3c !important; }
        .safe-active { background-color: #2ecc71 !important; }
        .loading-active { background-color: #f39c12 !important; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üî• GI√ÅM S√ÅT KH√ç GAS</h2>
        <div class="sub-title">C·∫£m bi·∫øn MQ-5 (Simon House)</div>

        <div id="gas-status-icon" style="font-size: 60px; margin-top: 10px;">üõ°Ô∏è</div>
        
        <div>
            <span id="gas-value">---</span>
            <span id="unit">ppm</span>
        </div>
        
        <div id="status-box" class="loading-active">ƒêang k·∫øt n·ªëi Server...</div>
        
        <div id="debug-error"></div>
    </div>

    <div class="footer">Server: broker.emqx.io | Port: 8084 (WSS Secure)</div>

    <script>
        // --- C·∫§U H√åNH SERVER M·ªöI (EMQX Public) ---
        // Server n√†y h·ªó tr·ª£ HTTPS r·∫•t t·ªët
        var mqtt_server = "broker.emqx.io";
        var mqtt_port = 8084; // C·ªïng b·∫£o m·∫≠t WSS cho Web
        var mqtt_path = "/mqtt"; // ƒê∆∞·ªùng d·∫´n b·∫Øt bu·ªôc c·ªßa EMQX
        
        var topic_value = "simon_house/gas/value";
        var topic_alert = "simon_house/gas/alert";
        
        var client = new Paho.MQTT.Client(mqtt_server, mqtt_port, mqtt_path, "web_client_" + parseInt(Math.random() * 10000, 10));

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        var options = {
            useSSL: true, // B·∫Øt bu·ªôc TRUE khi ch·∫°y tr√™n GitHub Pages
            timeout: 3,
            onSuccess: onConnect,
            onFailure: onFail
        };
        
        console.log("ƒêang k·∫øt n·ªëi t·ªõi " + mqtt_server + ":" + mqtt_port + mqtt_path);
        client.connect(options);

        // --- C√ÅC H√ÄM X·ª¨ L√ù ---

        function onConnect() {
            console.log("ƒê√£ k·∫øt n·ªëi Server th√†nh c√¥ng!");
            document.getElementById("status-box").innerText = "ƒê√£ k·∫øt n·ªëi! ƒêang ƒë·ª£i d·ªØ li·ªáu...";
            document.getElementById("status-box").className = "safe-active"; // M√†u xanh t·∫°m th·ªùi
            document.getElementById("debug-error").style.display = "none";
            
            client.subscribe("simon_house/gas/#");
        }

        function onFail(responseObject) {
            console.log("L·ªói k·∫øt n·ªëi: " + responseObject.errorMessage);
            document.getElementById("status-box").innerText = "L·ªói k·∫øt n·ªëi Server!";
            document.getElementById("status-box").className = "alarm-active";
            document.getElementById("debug-error").style.display = "block";
            document.getElementById("debug-error").innerText = "Chi ti·∫øt: " + responseObject.errorMessage;
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("M·∫•t k·∫øt n·ªëi: " + responseObject.errorMessage);
                document.getElementById("status-box").innerText = "M·∫•t k·∫øt n·ªëi Internet...";
            }
        }

        function onMessageArrived(message) {
            console.log("Nh·∫≠n tin: " + message.payloadString);
            
            if (message.destinationName == topic_value) {
                document.getElementById("gas-value").innerText = message.payloadString;
            }

            if (message.destinationName == topic_alert) {
                var msgContent = message.payloadString;
                var statusBox = document.getElementById("status-box");
                var valueText = document.getElementById("gas-value");
                var icon = document.getElementById("gas-status-icon");

                statusBox.innerText = msgContent;

                // Logic ƒë·ªïi m√†u
                if (msgContent.includes("CANH BAO") || msgContent.includes("NGUY HIEM") || msgContent.includes("RO RI")) {
                    statusBox.className = "alarm-active"; 
                    valueText.style.color = "#e74c3c";
                    icon.innerText = "‚ö†Ô∏è";
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
                } else if (msgContent.includes("An toan")) {
                    statusBox.className = "safe-active";
                    valueText.style.color = "#2ecc71";
                    icon.innerText = "üõ°Ô∏è";
                } else {
                    statusBox.className = "loading-active";
                    valueText.style.color = "#f39c12";
                }
            }
        }
    </script>

</body>
</html>
