<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Gi√°m S√°t Gas - Simon House</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #f4f4f9; text-align: center; padding: 20px; }
        .card { background: white; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); max-width: 400px; margin: auto; padding: 30px; }
        h2 { color: #333; margin-bottom: 5px; }
        .sub-title { font-size: 14px; color: #7f8c8d; margin-bottom: 20px; }
        
        #gas-value { font-size: 80px; font-weight: bold; color: #2ecc71; margin: 10px 0; transition: color 0.3s; }
        #unit { font-size: 20px; color: #95a5a6; }
        
        #status-box { padding: 15px; border-radius: 8px; color: white; font-weight: bold; font-size: 18px; margin-top: 15px; transition: background-color 0.3s; }
        
        .footer { margin-top: 30px; font-size: 12px; color: #888; }
        #debug-error { color: red; font-size: 14px; margin-top: 10px; display: none;}
        
        /* Hi·ªáu ·ª©ng nh·∫•p nh√°y khi b√°o ƒë·ªông */
        @keyframes blinker { 50% { opacity: 0.5; } }
        .alarm-active { animation: blinker 0.8s linear infinite; background-color: #e74c3c !important; }
        .safe-active { background-color: #2ecc71 !important; }
        .loading-active { background-color: #f39c12 !important; }
    </style>
</head>
<body>

    <div class="card">
        <h2>üî• GI√ÅM S√ÅT KH√ç GAS</h2>
        <div class="sub-title">C·∫£m bi·∫øn MQ-5 (Simon House)</div>

        <div id="gas-status-icon" style="font-size: 60px; margin-top: 10px;">üõ°Ô∏è</div>
        
        <div>
            <span id="gas-value">---</span>
            <span id="unit">ppm</span>
        </div>
        
        <div id="status-box" class="loading-active">ƒêang k·∫øt n·ªëi Server...</div>
        
        <div id="debug-error"></div>
    </div>

    <div class="footer">Server: test.mosquitto.org | Port: 8080 (WebSocket)</div>

    <script>
        // --- C·∫§U H√åNH SERVER (ƒê√£ ƒë·ªïi sang c·ªïng 8080 cho ·ªïn ƒë·ªãnh) ---
        var mqtt_server = "test.mosquitto.org";
        var mqtt_port = 8080; // <--- S·ª¨A TH√ÄNH 8080 (Kh√¥ng SSL)
        
        var topic_value = "simon_house/gas/value";
        var topic_alert = "simon_house/gas/alert";
        
        // T·∫°o Client ID ng·∫´u nhi√™n
        var client = new Paho.MQTT.Client(mqtt_server, mqtt_port, "web_client_" + parseInt(Math.random() * 10000, 10));

        client.onConnectionLost = onConnectionLost;
        client.onMessageArrived = onMessageArrived;

        // B·∫Øt ƒë·∫ßu k·∫øt n·ªëi
        var options = {
            useSSL: false, // <--- S·ª¨A TH√ÄNH FALSE (T·∫Øt SSL ƒë·ªÉ tr√°nh l·ªói Time out)
            timeout: 3,
            onSuccess: onConnect,
            onFailure: onFail
        };
        
        console.log("ƒêang k·∫øt n·ªëi t·ªõi " + mqtt_server + ":" + mqtt_port);
        client.connect(options);

        // --- C√ÅC H√ÄM X·ª¨ L√ù ---

        function onConnect() {
            console.log("ƒê√£ k·∫øt n·ªëi Server th√†nh c√¥ng!");
            document.getElementById("status-box").innerText = "ƒê√£ k·∫øt n·ªëi! Ch·ªù d·ªØ li·ªáu...";
            document.getElementById("status-box").className = "loading-active";
            document.getElementById("debug-error").style.display = "none";
            
            // ƒêƒÉng k√Ω nh·∫≠n tin t·ª´ c·∫£ 2 topic
            client.subscribe("simon_house/gas/#");
        }

        function onFail(responseObject) {
            console.log("K·∫øt n·ªëi TH·∫§T B·∫†I: " + responseObject.errorMessage);
            document.getElementById("status-box").innerText = "L·ªói k·∫øt n·ªëi Server!";
            document.getElementById("status-box").style.backgroundColor = "#7f8c8d";
            document.getElementById("debug-error").style.display = "block";
            document.getElementById("debug-error").innerText = "Chi ti·∫øt: " + responseObject.errorMessage;
        }

        function onConnectionLost(responseObject) {
            if (responseObject.errorCode !== 0) {
                console.log("M·∫•t k·∫øt n·ªëi: " + responseObject.errorMessage);
                document.getElementById("status-box").innerText = "M·∫•t k·∫øt n·ªëi Internet...";
                document.getElementById("status-box").style.backgroundColor = "#95a5a6";
            }
        }

        function onMessageArrived(message) {
            console.log("Topic: " + message.destinationName + " | Mess: " + message.payloadString);
            
            // 1. X·ª≠ l√Ω hi·ªÉn th·ªã S·ªê (Value)
            if (message.destinationName == topic_value) {
                var val = message.payloadString;
                document.getElementById("gas-value").innerText = val;
            }

            // 2. X·ª≠ l√Ω hi·ªÉn th·ªã TR·∫†NG TH√ÅI (Alert)
            // Code ESP8266 g·ª≠i chu·ªói text, ta hi·ªÉn th·ªã tr·ª±c ti·∫øp chu·ªói ƒë√≥
            if (message.destinationName == topic_alert) {
                var msgContent = message.payloadString;
                var statusBox = document.getElementById("status-box");
                var valueText = document.getElementById("gas-value");
                var icon = document.getElementById("gas-status-icon");

                // C·∫≠p nh·∫≠t n·ªôi dung ch·ªØ
                statusBox.innerText = msgContent;

                // Ki·ªÉm tra t·ª´ kh√≥a ƒë·ªÉ ƒë·ªïi m√†u (ƒê·ªìng b·ªô v·ªõi code C++)
                if (msgContent.includes("CANH BAO") || msgContent.includes("NGUY HIEM") || msgContent.includes("RO RI")) {
                    // --- TR·∫†NG TH√ÅI NGUY HI·ªÇM ---
                    statusBox.className = "alarm-active"; // M√†u ƒë·ªè + Nh·∫•p nh√°y
                    valueText.style.color = "#e74c3c";
                    icon.innerText = "‚ö†Ô∏è";
                    
                    // Rung ƒëi·ªán tho·∫°i
                    if (navigator.vibrate) navigator.vibrate([500, 200, 500]);

                } else if (msgContent.includes("An toan")) {
                    // --- TR·∫†NG TH√ÅI AN TO√ÄN ---
                    statusBox.className = "safe-active"; // M√†u xanh
                    valueText.style.color = "#2ecc71";
                    icon.innerText = "üõ°Ô∏è";

                } else {
                    // --- TR·∫†NG TH√ÅI KH·ªûI ƒê·ªòNG / KH√ÅC ---
                    statusBox.className = "loading-active"; // M√†u cam
                    valueText.style.color = "#f39c12";
                    icon.innerText = "‚è≥";
                }
            }
        }
    </script>
</body>
</html>
